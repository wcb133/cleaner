default_platform(:ios)

# å®šä¹‰å…¨å±€å‚æ•° å¤§å†™å¼€å¤´ä¸ºå¸¸æ•°,å°å†™ã€_å¼€å¤´ä¸ºå˜é‡,$å¼€å¤´ä¸ºå…¨å±€å˜é‡(ç›´æ¥ç”¨#è®¿é—®)
# schemeå
SCHEME_NAME = ENV['SCHEME_NAME']

# workspaceå
WORKSPACE_NAME = "#{SCHEME_NAME}.xcworkspace"

# plistæ–‡ä»¶è·¯å¾„
INFO_PLIST_PATH = "#{SCHEME_NAME}/Other/Info.plist"

# ç‰ˆæœ¬å·
$VERSION_NUMBER = ""

# æ„å»ºç‰ˆæœ¬å·
$BUILD_NUMBER = ""

# ipaå¯¼å‡ºè·¯å¾„
$OUTPUT_DIRECTORY = ENV['OUTPUT_DIRECTORY']

# ipaå®‰è£…åŒ…è·¯å¾„
$IPA_PATH = ""

# æ˜¯å¦å‡†å¤‡å®Œæˆ
$PREPARE_COMPLETED = false

platform :ios do
  before_all do
    # æ‰€æœ‰laneæ‰§è¡Œä¹‹å‰
    # ä½¿ç”¨ç¯å¢ƒå˜é‡æä¾›è¿™ä¸ªå¯†ç ç»™fastlaneï¼Œè§£å†³åŒé‡è®¤è¯ç”Ÿæˆçš„ç‰¹æ®Šå¯†ç 
    ENV["FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD"] = "hctd-fctb-mxrd-cxxc"
    # ENV["SLACK_URL"] = "https://hooks.slack.com/services/..."
    # æ‹‰å–è¿œç¨‹æœ€æ–°ä»£ç 
    # git_pull
    # æ‰§è¡Œ pod instasll
    # cocoapods
    # carthage
  end

  desc 'æ‰“åŒ…å‰çš„å‡†å¤‡å·¥ä½œ'
  lane :prepare do |options|
    if !$PREPARE_COMPLETED
      puts "\033[32m====================å³å°†å¼€å§‹æ‰“åŒ…====================\033[0m\n"
      puts 'æ‚¨å¥½ï¼Œå³å°†ä¸ºä½ è‡ªåŠ¨æ‰“åŒ…'
    end

    export_method = options[:export_method]
    select_method = '-1'
    # => å¦‚æœæ²¡æœ‰é€‰æ‹©æ‰“åŒ…æ–¹å¼ï¼Œæç¤ºé€‰æ‹©æ‰“åŒ…æ–¹å¼
    if export_method.nil? || export_method.empty?
      puts "è¯·é€‰æ‹©æ‰“åŒ…æ–¹å¼ \033[33m1:æ‰“åŒ…ä¸Šä¼ AppStore(é»˜è®¤) 2:æ‰“åŒ…Developmentä¸Šä¼ è’²å…¬è‹±Firm  3:æ‰“åŒ…AdHocä¸Šä¼ è’²å…¬è‹±Firm  4:æ‰“åŒ…Inhouseä¸Šä¼ è’²å…¬è‹±Firm  0:ç»“æŸæ‰“åŒ…  å›è½¦è¡¨ç¤ºä½¿ç”¨é»˜è®¤æ‰“åŒ…\033[0m"
      select_method = STDIN.gets.chomp
      if select_method!='1' && select_method!='2' && select_method!='3' && select_method!='4' && !select_method.empty?
        # supported [:select, :message, :verbose, :error, :password, :input, :success, :important, :command, :user_error!, :command_output, :deprecated, :header, :content_error, :interactive?, :confirm, :crash!, :not_implemented, :shell_error!, :build_failure!, :test_failure!, :abort_with_message!]
          UI.user_error!("æ‚¨å·²å–æ¶ˆæ‰“åŒ… ğŸš€")
      end
    end

    if !$PREPARE_COMPLETED
      currentVersion = get_info_plist_value(path: "#{INFO_PLIST_PATH}", key: "CFBundleShortVersionString")
      currentBuild = get_info_plist_value(path: "#{INFO_PLIST_PATH}", key: "CFBundleVersion")
      puts "å½“å‰å·¥ç¨‹çš„ç‰ˆæœ¬å·æ˜¯:\033[33m#{currentVersion}\033[0m æ„å»ºç‰ˆæœ¬å·æ˜¯:\033[33m#{currentBuild}\033[0m"
      version = options[:version]
      build = options[:build]
      output_directory = options[:output_directory]
      
      # => å¦‚æœæ²¡æœ‰é€‰æ‹©ç‰ˆæœ¬å·ï¼Œæç¤ºæ˜¯å¦éœ€è¦è¾“å…¥ç‰ˆæœ¬å·
      if version.nil? || version.empty?
        puts "è¯·è¾“å…¥ç‰ˆæœ¬å·ï¼Œå›è½¦è¡¨ç¤ºä½¿ç”¨å½“å‰ç‰ˆæœ¬å·\033[33m#{currentVersion}\033[0m"
        version = STDIN.gets.chomp
        if version == '' # å›è½¦
          $VERSION_NUMBER = currentVersion
        else
          $VERSION_NUMBER = version
        end
      else
        $VERSION_NUMBER = version
      end
      # => å¦‚æœæ²¡æœ‰é€‰æ‹©æ„å»ºç‰ˆæœ¬å·ï¼Œæç¤ºæ˜¯å¦éœ€è¦è¾“å…¥æ„å»ºç‰ˆæœ¬å·
      if build.nil? || build.empty?
        puts "è¯·è¾“å…¥æ„å»ºç‰ˆæœ¬å·ï¼Œå›è½¦è¡¨ç¤ºä½¿ç”¨é»˜è®¤è‡ªåŠ¨ç”Ÿæˆæ„å»ºç‰ˆæœ¬å·"
        build = STDIN.gets.chomp
        if build == '' # å›è½¦
          # $BUILD_NUMBER = AUTO_BUILD_NUMBER
        else
          $BUILD_NUMBER = build
        end
      else
        $BUILD_NUMBER = build
      end
      # => å¦‚æœæ²¡æœ‰é€‰æ‹©ipaè¾“å‡ºç›®å½•ï¼Œæç¤ºæ˜¯å¦éœ€è¦è¾“å…¥æ‰“åŒ…è·¯å¾„
      if output_directory.nil? || output_directory.empty?
        puts "è¯·æŒ‡å®šipaåŒ…è¾“å‡ºè·¯å¾„ï¼Œå›è½¦è¡¨ç¤ºä½¿ç”¨é»˜è®¤è¾“å‡ºè·¯å¾„:\033[33m#$OUTPUT_DIRECTORY\033[0m"
        output_directory = STDIN.gets.chomp
        if output_directory == '' # å›è½¦
        else
          $OUTPUT_DIRECTORY = output_directory
        end
      else
        $OUTPUT_DIRECTORY = output_directory
      end
    end
    
    $PREPARE_COMPLETED = true

    if select_method != '-1' # å·²é€‰æ‹©
      case select_method
      when '1'
        # å‘å¸ƒåˆ°appstore
        release_appstore(options)
      when '2'
        # æ‰“åŒ…Developmentæˆ–Adhocå‘å¸ƒåˆ°è’²å…¬è‹±Firm
        release_development(options)
      when '3'
        # æ‰“åŒ…Adhocå‘å¸ƒåˆ°è’²å…¬è‹±Firm
        release_adhoc(options)
      when '4'
        # æ‰“åŒ…inhouseå‘å¸ƒåˆ°è’²å…¬è‹±
        release_enterprise(options)
      end
      next
    end
    
    # => è¯¦ç»†ä¿¡æ¯
    summary(options)

  end

  desc "ä¿¡æ¯ç¡®è®¤"
  lane :summary do |options|
    puts "\033[32m====================ä¿¡æ¯ç¡®è®¤====================\033[0m\n"
    puts "æ‚¨è®¾ç½®çš„åŒ…è¾“å‡ºè·¯å¾„ä¸º:"
    # supported [:select, :message, :verbose, :error, :password, :input, :success, :important, :command, :user_error!, :command_output, :deprecated, :header, :content_error, :interactive?, :confirm, :crash!, :not_implemented, :shell_error!, :build_failure!, :test_failure!, :abort_with_message!]
    UI.important "#$OUTPUT_DIRECTORY"
    puts "æ‚¨é€‰æ‹©çš„æ‰“åŒ…æ–¹å¼ä¸º:"
    UI.important "#{options[:export_method]}"
    puts "æŒ‡å®šçš„å‘å¸ƒç‰ˆæœ¬å·ä¸º:"
    UI.important "#$VERSION_NUMBER"
    confirm = UI.confirm "ç¡®è®¤ä¿¡æ¯æ˜¯å¦æ­£ç¡®,è¾“å…¥yç»§ç»­æ‰“åŒ…"
    if !confirm
      UI.user_error!("æ‚¨å·²å–æ¶ˆæ‰“åŒ… ğŸš€")
    end
    puts "\033[32m====================ä¿¡æ¯ç¡®è®¤====================\033[0m\n"
    puts "3såå¼€å§‹è‡ªåŠ¨æ‰“åŒ…..."
    sleep(3)
  end

  desc "æ›´æ–°ç‰ˆæœ¬å·"
  lane :update_version do
    puts("*************| æ›´æ–°version #$VERSION_NUMBER |*************")
    increment_version_number_in_plist(
      target: SCHEME_NAME,
      version_number: $VERSION_NUMBER
    )
    puts("*************| æ›´æ–°build #$BUILD_NUMBER |*************")
    increment_build_number_in_plist(
       target: SCHEME_NAME,
       build_number: $BUILD_NUMBER
    )
  end

  desc "æ‰“åŒ…å‘å¸ƒ"
  lane :release do |options|
    prepare(options)
  end

  desc "å‘å¸ƒåˆ°appstore"
  lane :release_appstore do |options|
    options[:export_method] = "app-store"
    prepare(options)
    build(options)
    deliver_appstore
    end

  desc "å‘å¸ƒdevelopment"
  lane :release_development do |options|
    options[:export_method] = "development"
    prepare(options)
    build(options)
    deliver_pgyer
    deliver_firm
  end

  desc "å‘å¸ƒad-hoc"
  lane :release_adhoc do |options|
    options[:export_method] = "ad-hoc"
    prepare(options)
    build(options)
    # deliver_pgyer
    deliver_firm
  end

  desc "å‘å¸ƒä¼ä¸šInhouse"
  lane :release_enterprise do |options|
    options[:export_method] = "enterprise"
    prepare(options)
    build(options)
    deliver_pgyer
    deliver_firm
  end

  desc "ä¸Šä¼ åˆ°è’²å…¬è‹±"
  lane :deliver_pgyer do |options|
    pgyer(
       api_key: ENV['PGYER_API_KEY'], # ä»è’²å…¬è‹±é¡¹ç›®è¯¦æƒ…ä¸­è·å–çš„apikey
       user_key: ENV['PGYER_USER_KEY'], # ä»è’²å…¬è‹±é¡¹ç›®è¯¦æƒ…ä¸­è·å–çš„ userkey
       #apk: $APK_PATH, #apkåŒ…è·¯å¾„
       ipa: $IPA_PATH, #ipaåŒ…è·¯å¾„
       install_type: ENV['PGYER_INSTALL_TYPE'], #1ï¼šå…¬å¼€ï¼Œ2ï¼šå¯†ç å®‰è£…ï¼Œ3ï¼šé‚€è¯·å®‰è£…ï¼Œ4ï¼šå›ç­”é—®é¢˜å®‰è£…ã€‚é»˜è®¤ä¸º1å…¬å¼€
       password: ENV['PGYER_INSTALL_PASSWORD'], #è®¾ç½®å®‰è£…å¯†ç 
       update_description: ENV['UPDATE_DESCRIPTION'] #æ›´æ–°æè¿°
    )
  end

  desc "ä¸Šä¼ åˆ°Firm"
  lane :deliver_firm do |options|
    firim(
       firim_api_token: ENV['Firm_API_Token'], # ä»Firmé¡¹ç›®è¯¦æƒ…ä¸­è·å–çš„apitoken
       ipa: $IPA_PATH, #ipaåŒ…è·¯å¾„
       # icon: ENV['APPICON_PATH'] #icon
    )
  end
  
  desc "ä¸Šä¼ åˆ°appstore"
  lane :deliver_appstore do |options|
    deliver( 
       username: ENV['APPLE_ID'], # å¼€å‘è€…è´¦å·
       team_id: ENV['ITC_TEAM_ID'], # ITC Team ID
       dev_portal_team_id: ENV['TEAM_ID'], # ADC Team ID
       app_identifier: ENV['APP_IDENTIFIER'], # bundle ID
       ipa: $IPA_PATH, # ipaåŒ…è·¯å¾„
       app_version: $VERSION_NUMBER, # æ›´æ–°ç‰ˆæœ¬å·
       release_notes: {
         'zh-Hans' => "è¿™æ˜¯ç¬¬ä¸€ä¸ªç‰ˆæœ¬å“¦"
       },
       force: true, # è®¾ç½®trueï¼Œä¼šè·³è¿‡é¢„è§ˆé¡µé¢ï¼Œç›´æ¥ä¸Šæ¶
       skip_screenshots: true, # ä¸ä¸Šä¼ æˆªå›¾
       skip_metadata: true, # ä¸ä¸Šä¼ å…ƒæ•°æ®
    )
  end

  desc "æ‰“åŒ…"
  lane :build do |options|
    # gymç”¨æ¥ç¼–è¯‘ipa
    # ç¼–è¯‘æ—¶é—´
    build_time = Time.now.strftime("%Y-%m-%d %H-%M-%S")
    # è‡ªåŠ¨ç”Ÿæˆçš„buildç‰ˆæœ¬å·
    auto_build_number = Time.now.strftime("%Y%m%d%H%M%S")
    if $BUILD_NUMBER.empty?
      $BUILD_NUMBER = auto_build_number
    end

    # æ›´æ–°ç‰ˆæœ¬å·
    update_version

    # è·å–æ‰“åŒ…æ–¹å¼
    export_method = options[:export_method]
    # é…ç½®é¡¹
    configuration = 'Release'
    # ppæ–‡ä»¶
    provisioningProfiles = ENV['PP_APPSTORE']
    # è¾“å‡ºç›®å½•
    outputDir = ''
    # è¾“å‡ºæ–‡ä»¶å
    outputName = "#{SCHEME_NAME}_#$VERSION_NUMBER_#$BUILD_NUMBER_#{export_method}.ipa"
    case export_method
    when 'development'
      configuration = 'Debug'
      outputDir = "#$OUTPUT_DIRECTORY/Development/#{SCHEME_NAME}-#{build_time}"
    when 'app-store'
      outputDir = "#$OUTPUT_DIRECTORY/Appstore/#{SCHEME_NAME}-#{build_time}"
    when 'ad-hoc'
       provisioningProfiles = ENV['PP_ADHOC']
       outputDir = "#$OUTPUT_DIRECTORY/ADHOC/#{SCHEME_NAME}-#{build_time}"
    when 'enterprise'
       provisioningProfiles = ENV['PP_ENTERPRISE']
       outputDir = "#$OUTPUT_DIRECTORY/ADHOC/#{SCHEME_NAME}-#{build_time}"
    end
   
    $IPA_PATH = gym(
       clean: 'true', # åœ¨æ‰“åŒ…å‰æ˜¯å¦å…ˆæ‰§è¡Œcleanã€‚
       scheme: "#{SCHEME_NAME}", # æŒ‡å®šé¡¹ç›®çš„schemeåç§°
       workspace: "#{WORKSPACE_NAME}", # æŒ‡å®š.xcworkspaceæ–‡ä»¶çš„è·¯å¾„ã€‚
       configuration: "#{configuration}", # æŒ‡å®šæ‰“åŒ…æ—¶çš„é…ç½®é¡¹ï¼Œé»˜è®¤ä¸ºRelease
       output_name: "#{outputName}", # æŒ‡å®šç”Ÿæˆçš„.ipaæ–‡ä»¶çš„åç§°ï¼Œåº”åŒ…å«æ–‡ä»¶æ‰©å±•åã€‚
       output_directory: "#{outputDir}", # æŒ‡å®š.ipaæ–‡ä»¶çš„è¾“å‡ºç›®å½•
       include_symbols: 'true', # æ˜¯å¦å¯¼å‡ºç¬¦å·è¡¨
       # include_bitcode: 'false',  # æ˜¯å¦ä½¿ç”¨bitcodeæ‰“åŒ…
       export_xcargs: "-allowProvisioningUpdates", #è®¿é—®é’¥åŒ™ä¸²
       silent: true,  # æ˜¯å¦éšè—æ‰“åŒ…æ—¶ä¸éœ€è¦çš„ä¿¡æ¯ã€‚
       buildlog_path: "#{outputDir}", # æŒ‡å®šç¼–è¯‘æ—¥å¿—æ–‡ä»¶çš„è¾“å‡ºç›®å½•
       export_options: {
        method: "#{export_method}", # æŒ‡å®šå¯¼å‡º.ipaæ—¶ä½¿ç”¨çš„æ–¹æ³•ï¼Œå¯ç”¨é€‰é¡¹ï¼šapp-store,ad-hoc,enterprise,development
        thinning: "<none>",  # æ˜¯å¦ç˜¦èº«
       }
    )
  end

  after_all do |lane|
    # åœ¨macOS é€šçŸ¥æ å‘é€é€šçŸ¥
    notification(subtitle: "Successfully", message: "Successfully deployed new App Update")
    #slack(
    #   message: "Successfully deployed new App Update."
    #)
  end

  error do |lane, exception|
     #slack(
     #  message: exception.message,
     #  success: false
     #)
  end

end